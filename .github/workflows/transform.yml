on:
  workflow_dispatch:
  repository_dispatch:
    types: [release_event]

name: Transform Data

jobs:
  # ------------------------------------------------------------------------------
  # Download retrieved data once and share via artifact
  # ------------------------------------------------------------------------------
  download_retrieved_data:
    name: Download Retrieved Data
    runs-on: ubuntu-latest
    steps:
      - uses: clusterflick/release-downloader@v1
        with:
          token: ${{ secrets.PAT }}
          repository: "clusterflick/data-retrieved"
          latest: true
          fileName: "*"
          out-file-path: "retrieved-data"
      - name: Upload Retrieved Data
        uses: actions/upload-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
          retention-days: 1

  # ------------------------------------------------------------------------------
  # Download historical combined data (last 10 days) and share via artifact
  # ------------------------------------------------------------------------------
  download_historical_data:
    name: Download Historical Data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: clusterflick/scripts
      - name: Download Last 10 Days Combined Data
        run: bash helpers/get-last-10-days-combined-data.sh
      - name: Upload Historical Data
        uses: actions/upload-artifact@v4
        with:
          name: combined-data
          path: combined-data/
          retention-days: 1

  # ------------------------------------------------------------------------------
  # Transform BFI
  # ------------------------------------------------------------------------------
  transform_bfi:
    name: Transform BFI
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: bfi.org.uk-imax
        run: npx clusterflick/scripts transform bfi.org.uk-imax
      - name: bfi.org.uk-southbank
        run: npx clusterflick/scripts transform bfi.org.uk-southbank

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_bfi
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Cineworld
  # ------------------------------------------------------------------------------
  transform_cineworld:
    name: Transform Cineworld
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: cineworld.co.uk-bexleyheath
        run: npx clusterflick/scripts transform cineworld.co.uk-bexleyheath
      - name: cineworld.co.uk-enfield
        run: npx clusterflick/scripts transform cineworld.co.uk-enfield
      - name: cineworld.co.uk-feltham
        run: npx clusterflick/scripts transform cineworld.co.uk-feltham
      - name: cineworld.co.uk-hounslow
        run: npx clusterflick/scripts transform cineworld.co.uk-hounslow
      - name: cineworld.co.uk-ilford
        run: npx clusterflick/scripts transform cineworld.co.uk-ilford
      - name: cineworld.co.uk-leicester-square
        run: npx clusterflick/scripts transform cineworld.co.uk-leicester-square
      - name: cineworld.co.uk-south-ruislip
        run: npx clusterflick/scripts transform cineworld.co.uk-south-ruislip
      - name: cineworld.co.uk-the-o2-greenwich
        run: npx clusterflick/scripts transform cineworld.co.uk-the-o2-greenwich
      - name: cineworld.co.uk-wandsworth
        run: npx clusterflick/scripts transform cineworld.co.uk-wandsworth
      - name: cineworld.co.uk-wembley
        run: npx clusterflick/scripts transform cineworld.co.uk-wembley
      - name: cineworld.co.uk-west-india-quay
        run: npx clusterflick/scripts transform cineworld.co.uk-west-india-quay
      - name: cineworld.co.uk-wood-green
        run: npx clusterflick/scripts transform cineworld.co.uk-wood-green

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_cineworld
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Curzon
  # ------------------------------------------------------------------------------
  transform_curzon:
    name: Transform Curzon
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: curzon.com-aldgate
        run: npx clusterflick/scripts transform curzon.com-aldgate
      - name: curzon.com-bloomsbury
        run: npx clusterflick/scripts transform curzon.com-bloomsbury
      - name: curzon.com-camden
        run: npx clusterflick/scripts transform curzon.com-camden
      - name: curzon.com-hoxton
        run: npx clusterflick/scripts transform curzon.com-hoxton
      - name: curzon.com-kingston
        run: npx clusterflick/scripts transform curzon.com-kingston
      - name: curzon.com-mayfair
        run: npx clusterflick/scripts transform curzon.com-mayfair
      - name: curzon.com-richmond
        run: npx clusterflick/scripts transform curzon.com-richmond
      - name: curzon.com-soho
        run: npx clusterflick/scripts transform curzon.com-soho
      - name: curzon.com-victoria
        run: npx clusterflick/scripts transform curzon.com-victoria
      - name: curzon.com-wimbledon
        run: npx clusterflick/scripts transform curzon.com-wimbledon
      - name: curzonseacontainers.com
        run: npx clusterflick/scripts transform curzonseacontainers.com

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_curzon
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Electric Cinema
  # ------------------------------------------------------------------------------
  transform_electric_cinema:
    name: Transform Electric Cinema
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: electriccinema.co.uk-portobello
        run: npx clusterflick/scripts transform electriccinema.co.uk-portobello
      - name: electriccinema.co.uk-white-city
        run: npx clusterflick/scripts transform electriccinema.co.uk-white-city

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_electric_cinema
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Tate
  # ------------------------------------------------------------------------------
  transform_tate:
    name: Transform Tate
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: tate.org.uk-tate-britain
        run: npx clusterflick/scripts transform tate.org.uk-tate-britain
      - name: tate.org.uk-tate-modern
        run: npx clusterflick/scripts transform tate.org.uk-tate-modern

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_tate
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Firmdale Hotels
  # ------------------------------------------------------------------------------
  transform_firmdale_hotels:
    name: Transform Firmdale Hotels
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: firmdalehotels.com-charlotte-street
        run: npx clusterflick/scripts transform firmdalehotels.com-charlotte-street
      - name: firmdalehotels.com-covent-garden
        run: npx clusterflick/scripts transform firmdalehotels.com-covent-garden
      - name: firmdalehotels.com-soho
        run: npx clusterflick/scripts transform firmdalehotels.com-soho

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_firmdale_hotels
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Everyman
  # ------------------------------------------------------------------------------
  transform_everyman:
    name: Transform Everyman
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: everymancinema.com-baker-street
        run: npx clusterflick/scripts transform everymancinema.com-baker-street
      - name: everymancinema.com-barnet
        run: npx clusterflick/scripts transform everymancinema.com-barnet
      - name: everymancinema.com-belsize-park
        run: npx clusterflick/scripts transform everymancinema.com-belsize-park
      - name: everymancinema.com-borough-yards
        run: npx clusterflick/scripts transform everymancinema.com-borough-yards
      - name: everymancinema.com-brentford
        run: npx clusterflick/scripts transform everymancinema.com-brentford
      - name: everymancinema.com-broadgate
        run: npx clusterflick/scripts transform everymancinema.com-broadgate
      - name: everymancinema.com-canary-wharf
        run: npx clusterflick/scripts transform everymancinema.com-canary-wharf
      - name: everymancinema.com-chelsea
        run: npx clusterflick/scripts transform everymancinema.com-chelsea
      - name: everymancinema.com-crystal-palace
        run: npx clusterflick/scripts transform everymancinema.com-crystal-palace
      - name: everymancinema.com-hampstead
        run: npx clusterflick/scripts transform everymancinema.com-hampstead
      - name: everymancinema.com-kings-cross
        run: npx clusterflick/scripts transform everymancinema.com-kings-cross
      - name: everymancinema.com-maida-vale
        run: npx clusterflick/scripts transform everymancinema.com-maida-vale
      - name: everymancinema.com-muswell-hill
        run: npx clusterflick/scripts transform everymancinema.com-muswell-hill
      - name: everymancinema.com-screen-on-the-green
        run: npx clusterflick/scripts transform everymancinema.com-screen-on-the-green
      - name: everymancinema.com-stratford-international
        run: npx clusterflick/scripts transform everymancinema.com-stratford-international
      - name: everymancinema.com-the-whiteley
        run: npx clusterflick/scripts transform everymancinema.com-the-whiteley

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_everyman
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Vue
  # ------------------------------------------------------------------------------
  transform_vue:
    name: Transform Vue
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: myvue.com-bromley
        run: npx clusterflick/scripts transform myvue.com-bromley
      - name: myvue.com-croydon-grants
        run: npx clusterflick/scripts transform myvue.com-croydon-grants
      - name: myvue.com-croydon-purley-way
        run: npx clusterflick/scripts transform myvue.com-croydon-purley-way
      - name: myvue.com-dagenham
        run: npx clusterflick/scripts transform myvue.com-dagenham
      - name: myvue.com-eltham
        run: npx clusterflick/scripts transform myvue.com-eltham
      - name: myvue.com-finchley-road
        run: npx clusterflick/scripts transform myvue.com-finchley-road
      - name: myvue.com-fulham-broadway
        run: npx clusterflick/scripts transform myvue.com-fulham-broadway
      - name: myvue.com-harrow
        run: npx clusterflick/scripts transform myvue.com-harrow
      - name: myvue.com-islington
        run: npx clusterflick/scripts transform myvue.com-islington
      - name: myvue.com-leicester-square
        run: npx clusterflick/scripts transform myvue.com-leicester-square
      - name: myvue.com-north-finchley
        run: npx clusterflick/scripts transform myvue.com-north-finchley
      - name: myvue.com-piccadilly
        run: npx clusterflick/scripts transform myvue.com-piccadilly
      - name: myvue.com-romford
        run: npx clusterflick/scripts transform myvue.com-romford
      - name: myvue.com-shepherds-bush
        run: npx clusterflick/scripts transform myvue.com-shepherds-bush
      - name: myvue.com-westfield
        run: npx clusterflick/scripts transform myvue.com-westfield
      - name: myvue.com-westfield-stratford-city
        run: npx clusterflick/scripts transform myvue.com-westfield-stratford-city
      - name: myvue.com-wood-green
        run: npx clusterflick/scripts transform myvue.com-wood-green

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_vue
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform ODEON
  # ------------------------------------------------------------------------------
  transform_odeon:
    name: Transform ODEON
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: odeon.co.uk-acton
        run: npx clusterflick/scripts transform odeon.co.uk-acton
      - name: odeon.co.uk-beckenham
        run: npx clusterflick/scripts transform odeon.co.uk-beckenham
      - name: odeon.co.uk-camden
        run: npx clusterflick/scripts transform odeon.co.uk-camden
      - name: odeon.co.uk-greenwich
        run: npx clusterflick/scripts transform odeon.co.uk-greenwich
      - name: odeon.co.uk-haymarket
        run: npx clusterflick/scripts transform odeon.co.uk-haymarket
      - name: odeon.co.uk-holloway
        run: npx clusterflick/scripts transform odeon.co.uk-holloway
      - name: odeon.co.uk-islington
        run: npx clusterflick/scripts transform odeon.co.uk-islington
      - name: odeon.co.uk-kingston
        run: npx clusterflick/scripts transform odeon.co.uk-kingston
      - name: odeon.co.uk-lee-valley
        run: npx clusterflick/scripts transform odeon.co.uk-lee-valley
      - name: odeon.co.uk-leicester-square
        run: npx clusterflick/scripts transform odeon.co.uk-leicester-square
      - name: odeon.co.uk-orpington
        run: npx clusterflick/scripts transform odeon.co.uk-orpington
      - name: odeon.co.uk-putney
        run: npx clusterflick/scripts transform odeon.co.uk-putney
      - name: odeon.co.uk-richmond
        run: npx clusterflick/scripts transform odeon.co.uk-richmond
      - name: odeon.co.uk-south-woodford
        run: npx clusterflick/scripts transform odeon.co.uk-south-woodford
      - name: odeon.co.uk-streatham
        run: npx clusterflick/scripts transform odeon.co.uk-streatham
      - name: odeon.co.uk-swiss-cottage
        run: npx clusterflick/scripts transform odeon.co.uk-swiss-cottage
      - name: odeon.co.uk-tottenham-court-road
        run: npx clusterflick/scripts transform odeon.co.uk-tottenham-court-road
      - name: odeon.co.uk-uxbridge
        run: npx clusterflick/scripts transform odeon.co.uk-uxbridge
      - name: odeon.co.uk-west-end
        run: npx clusterflick/scripts transform odeon.co.uk-west-end
      - name: odeon.co.uk-wimbledon
        run: npx clusterflick/scripts transform odeon.co.uk-wimbledon

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_odeon
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform Picturehouses
  # ------------------------------------------------------------------------------
  transform_picturehouses:
    name: Transform Picturehouses
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: picturehouses.com-central
        run: npx clusterflick/scripts transform picturehouses.com-central
      - name: picturehouses.com-clapham
        run: npx clusterflick/scripts transform picturehouses.com-clapham
      - name: picturehouses.com-crouch-end
        run: npx clusterflick/scripts transform picturehouses.com-crouch-end
      - name: picturehouses.com-ealing
        run: npx clusterflick/scripts transform picturehouses.com-ealing
      - name: picturehouses.com-east-dulwich
        run: npx clusterflick/scripts transform picturehouses.com-east-dulwich
      - name: picturehouses.com-greenwich
        run: npx clusterflick/scripts transform picturehouses.com-greenwich
      - name: picturehouses.com-finsbury-park
        run: npx clusterflick/scripts transform picturehouses.com-finsbury-park
      - name: picturehouses.com-hackney
        run: npx clusterflick/scripts transform picturehouses.com-hackney
      - name: picturehouses.com-the-gate
        run: npx clusterflick/scripts transform picturehouses.com-the-gate
      - name: picturehouses.com-the-ritzy
        run: npx clusterflick/scripts transform picturehouses.com-the-ritzy
      - name: picturehouses.com-west-norwood
        run: npx clusterflick/scripts transform picturehouses.com-west-norwood

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_picturehouses
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinema organisations (Part 1)
  # ------------------------------------------------------------------------------
  transform_organisations_1:
    name: Transform Organisations 1
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: barbican.org.uk
        run: npx clusterflick/scripts transform barbican.org.uk
      - name: cinemamuseum.org.uk
        run: npx clusterflick/scripts transform cinemamuseum.org.uk
      - name: riversidestudios.co.uk
        run: npx clusterflick/scripts transform riversidestudios.co.uk
      - name: sciencemuseum.org.uk
        run: npx clusterflick/scripts transform sciencemuseum.org.uk
      - name: ica.art
        run: npx clusterflick/scripts transform ica.art

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_organisations_1
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinema organisations (Part 2)
  # ------------------------------------------------------------------------------
  transform_organisations_2:
    name: Transform Organisations 2
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: institut-francais.org.uk
        run: npx clusterflick/scripts transform institut-francais.org.uk
      - name: jw3.org.uk
        run: npx clusterflick/scripts transform jw3.org.uk
      - name: princecharlescinema.com
        run: npx clusterflick/scripts transform princecharlescinema.com
      - name: genesiscinema.co.uk
        run: npx clusterflick/scripts transform genesiscinema.co.uk

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_organisations_2
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 1)
  # ------------------------------------------------------------------------------
  transform_external_events_1:
    name: Transform External Events 1
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: allisjoysoho.com
        run: npx clusterflick/scripts transform allisjoysoho.com
      - name: beermerchantstap.com
        run: npx clusterflick/scripts transform beermerchantstap.com
      - name: freud.org.uk
        run: npx clusterflick/scripts transform freud.org.uk
      - name: pelicanhouse.org
        run: npx clusterflick/scripts transform pelicanhouse.org
      - name: artotel.com-battersea-power-station
        run: npx clusterflick/scripts transform artotel.com-battersea-power-station
      - name: artotel.com-hoxton
        run: npx clusterflick/scripts transform artotel.com-hoxton
      - name: claphamgrand.com
        run: npx clusterflick/scripts transform claphamgrand.com
      - name: rivoliballroom.com
        run: npx clusterflick/scripts transform rivoliballroom.com
      - name: beehiven17.com
        run: npx clusterflick/scripts transform beehiven17.com
      - name: boxpark.co.uk-wembley
        run: npx clusterflick/scripts transform boxpark.co.uk-wembley
      - name: frontlineclub.com
        run: npx clusterflick/scripts transform frontlineclub.com
      - name: ivyhousenunhead.com
        run: npx clusterflick/scripts transform ivyhousenunhead.com
      - name: rocketvan.co.uk
        run: npx clusterflick/scripts transform rocketvan.co.uk
      - name: theatreship.co.uk
        run: npx clusterflick/scripts transform theatreship.co.uk
      - name: imperial.ac.uk
        run: npx clusterflick/scripts transform imperial.ac.uk
      - name: culture.hu-london
        run: npx clusterflick/scripts transform culture.hu-london
      - name: kerbsocialclub.com
        run: npx clusterflick/scripts transform kerbsocialclub.com

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_1
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 2)
  # ------------------------------------------------------------------------------
  transform_external_events_2:
    name: Transform External Events 2
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: uel.ac.uk-the-source
        run: npx clusterflick/scripts transform uel.ac.uk-the-source
      - name: bfi.org.uk-stephen-street
        run: npx clusterflick/scripts transform bfi.org.uk-stephen-street
      - name: goethe.de
        run: npx clusterflick/scripts transform goethe.de
      - name: marriott.com-w-london
        run: npx clusterflick/scripts transform marriott.com-w-london
      - name: mason-fifth.com-westbourne-park
        run: npx clusterflick/scripts transform mason-fifth.com-westbourne-park
      - name: ronspeckham.com
        run: npx clusterflick/scripts transform ronspeckham.com
      - name: theexhibit.co.uk
        run: npx clusterflick/scripts transform theexhibit.co.uk
      - name: castlehaven.org.uk
        run: npx clusterflick/scripts transform castlehaven.org.uk
      - name: japanhouselondon.uk
        run: npx clusterflick/scripts transform japanhouselondon.uk
      - name: chcc.org.uk
        run: npx clusterflick/scripts transform chcc.org.uk
      - name: crick.ac.uk
        run: npx clusterflick/scripts transform crick.ac.uk
      - name: fellowshipinn.co.uk
        run: npx clusterflick/scripts transform fellowshipinn.co.uk
      - name: islington.gov.uk-black-cultural-centre
        run: npx clusterflick/scripts transform islington.gov.uk-black-cultural-centre
      - name: thehenandchickenstheatrebar.co.uk
        run: npx clusterflick/scripts transform thehenandchickenstheatrebar.co.uk
      - name: londonwelsh.org
        run: npx clusterflick/scripts transform londonwelsh.org
      - name: london.czechcentres.cz
        run: npx clusterflick/scripts transform london.czechcentres.cz

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_2
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 3)
  # ------------------------------------------------------------------------------
  transform_external_events_3:
    name: Transform External Events 3
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: gold.ac.uk
        run: npx clusterflick/scripts transform gold.ac.uk
      - name: islington.gov.uk-islington-museum
        run: npx clusterflick/scripts transform islington.gov.uk-islington-museum
      - name: kcl.ac.uk-strand
        run: npx clusterflick/scripts transform kcl.ac.uk-strand
      - name: khccc.com
        run: npx clusterflick/scripts transform khccc.com
      - name: metrolandcultures.com
        run: npx clusterflick/scripts transform metrolandcultures.com
      - name: myheathway.com
        run: npx clusterflick/scripts transform myheathway.com
      - name: newtownculture.org-womens-museum
        run: npx clusterflick/scripts transform newtownculture.org-womens-museum
      - name: princeofpeckham.co.uk
        run: npx clusterflick/scripts transform princeofpeckham.co.uk
      - name: better.org.uk-croydon-sports-arena
        run: npx clusterflick/scripts transform better.org.uk-croydon-sports-arena
      - name: dalstonsuperstore.com
        run: npx clusterflick/scripts transform dalstonsuperstore.com
      - name: ethicalproperty.co.uk-the-green-house
        run: npx clusterflick/scripts transform ethicalproperty.co.uk-the-green-house
      - name: william-the-fourth.com
        run: npx clusterflick/scripts transform william-the-fourth.com
      - name: thewildsbarkingriverside.london
        run: npx clusterflick/scripts transform thewildsbarkingriverside.london
      - name: peckhamlevels.org
        run: npx clusterflick/scripts transform peckhamlevels.org
      - name: rbkc.gov.uk-kensington-central-library
        run: npx clusterflick/scripts transform rbkc.gov.uk-kensington-central-library

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_3
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 4)
  # ------------------------------------------------------------------------------
  transform_external_events_4:
    name: Transform External Events 4
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: exchangetwickenham.co.uk
        run: npx clusterflick/scripts transform exchangetwickenham.co.uk
      - name: langleyfilmbox.com
        run: npx clusterflick/scripts transform langleyfilmbox.com
      - name: scrt.onl
        run: npx clusterflick/scripts transform scrt.onl
      - name: sohoscreeningrooms.co.uk
        run: npx clusterflick/scripts transform sohoscreeningrooms.co.uk
      - name: thexchange.org.uk
        run: npx clusterflick/scripts transform thexchange.org.uk
      - name: uk.kef.com
        run: npx clusterflick/scripts transform uk.kef.com
      - name: irishculturalcentre.co.uk
        run: npx clusterflick/scripts transform irishculturalcentre.co.uk
      - name: boathousebarkingstudios.com
        run: npx clusterflick/scripts transform boathousebarkingstudios.com
      - name: feministlibrary.co.uk
        run: npx clusterflick/scripts transform feministlibrary.co.uk
      - name: goodhotel.co-london
        run: npx clusterflick/scripts transform goodhotel.co-london
      - name: aplaceforchange.co.uk
        run: npx clusterflick/scripts transform aplaceforchange.co.uk
      - name: mothclub.co.uk
        run: npx clusterflick/scripts transform mothclub.co.uk
      - name: lux.org.uk
        run: npx clusterflick/scripts transform lux.org.uk
      - name: rca.ac.uk-battersea
        run: npx clusterflick/scripts transform rca.ac.uk-battersea
      - name: rca.ac.uk-kensington
        run: npx clusterflick/scripts transform rca.ac.uk-kensington

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_4
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 5)
  # ------------------------------------------------------------------------------
  transform_external_events_5:
    name: Transform External Events 5
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: qmul.ac.uk-bloc
        run: npx clusterflick/scripts transform qmul.ac.uk-bloc
      - name: thersa.org
        run: npx clusterflick/scripts transform thersa.org
      - name: ucl.ac.uk-ucl-east-community-cinema
        run: npx clusterflick/scripts transform ucl.ac.uk-ucl-east-community-cinema
      - name: courthouse-hotel.com-shoreditch
        run: npx clusterflick/scripts transform courthouse-hotel.com-shoreditch
      - name: courthouse-hotel.com-soho
        run: npx clusterflick/scripts transform courthouse-hotel.com-soho
      - name: facebook.com-thehaggerston
        run: npx clusterflick/scripts transform facebook.com-thehaggerston
      - name: signaturebrew.co.uk-blackhorseroad
        run: npx clusterflick/scripts transform signaturebrew.co.uk-blackhorseroad
      - name: walthamforest.gov.uk
        run: npx clusterflick/scripts transform walthamforest.gov.uk
      - name: bulgarihotels.com
        run: npx clusterflick/scripts transform bulgarihotels.com
      - name: cine-real.com
        run: npx clusterflick/scripts transform cine-real.com
      - name: piehousecoop.co.uk
        run: npx clusterflick/scripts transform piehousecoop.co.uk
      - name: professional.dolby.com-soho
        run: npx clusterflick/scripts transform professional.dolby.com-soho
      - name: setspace.uk
        run: npx clusterflick/scripts transform setspace.uk
      - name: thcentre.com
        run: npx clusterflick/scripts transform thcentre.com
      - name: uel.ac.uk-univeristy-square-stratford
        run: npx clusterflick/scripts transform uel.ac.uk-univeristy-square-stratford

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_5
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform cinemas which rely on external event sources (Part 6)
  # ------------------------------------------------------------------------------
  transform_external_events_6:
    name: Transform External Events 6
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: themayfairhotel.co.uk
        run: npx clusterflick/scripts transform themayfairhotel.co.uk
      - name: reinstate.info
        run: npx clusterflick/scripts transform reinstate.info
      - name: scarlettmalone.com-subtitlecinema
        run: npx clusterflick/scripts transform scarlettmalone.com-subtitlecinema
      - name: shaispace.com
        run: npx clusterflick/scripts transform shaispace.com
      - name: strongroombar.com
        run: npx clusterflick/scripts transform strongroombar.com
      - name: thamesmeadnow.org.uk-the-nest
        run: npx clusterflick/scripts transform thamesmeadnow.org.uk-the-nest
      - name: thethomaswallcentre.harleystreethypnosis.co.uk
        run: npx clusterflick/scripts transform thethomaswallcentre.harleystreethypnosis.co.uk
      - name: ucl.ac.uk-bentham-house
        run: npx clusterflick/scripts transform ucl.ac.uk-bentham-house
      - name: ucl.ac.uk-ssees
        run: npx clusterflick/scripts transform ucl.ac.uk-ssees
      - name: stmarys.ac.uk-the-1850
        run: npx clusterflick/scripts transform stmarys.ac.uk-the-1850
      - name: thedivine.co.uk
        run: npx clusterflick/scripts transform thedivine.co.uk
      - name: triangledeptford.org
        run: npx clusterflick/scripts transform triangledeptford.org
      - name: thegreennunhead.org
        run: npx clusterflick/scripts transform thegreennunhead.org
      - name: vaginamuseum.co.uk
        run: npx clusterflick/scripts transform vaginamuseum.co.uk
      - name: wienerholocaustlibrary.org
        run: npx clusterflick/scripts transform wienerholocaustlibrary.org
      - name: objetstrouves.co.uk
        run: npx clusterflick/scripts transform objetstrouves.co.uk
      - name: stmchurch.co.uk
        run: npx clusterflick/scripts transform stmchurch.co.uk

      - name: 229.london
        run: npx clusterflick/scripts transform 229.london

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_external_events_6
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform all cinemas not part of a large chain (Part 1)
  # ------------------------------------------------------------------------------
  transform_remaining_1:
    name: Transform Remaining 1
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: olympiccinema.com
        run: npx clusterflick/scripts transform olympiccinema.com
      - name: thecinemaatselfridges.com
        run: npx clusterflick/scripts transform thecinemaatselfridges.com
      - name: thecinemainthepowerstation.com
        run: npx clusterflick/scripts transform thecinemainthepowerstation.com
      - name: regentstreetcinema.com
        run: npx clusterflick/scripts transform regentstreetcinema.com
      - name: phoenixcinema.co.uk
        run: npx clusterflick/scripts transform phoenixcinema.co.uk
      - name: actonecinema.co.uk
        run: npx clusterflick/scripts transform actonecinema.co.uk
      - name: chiswickcinema.co.uk
        run: npx clusterflick/scripts transform chiswickcinema.co.uk
      - name: riocinema.org.uk
        run: npx clusterflick/scripts transform riocinema.org.uk
      - name: thelexicinema.co.uk
        run: npx clusterflick/scripts transform thelexicinema.co.uk
      - name: thearzner.com
        run: npx clusterflick/scripts transform thearzner.com

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_remaining_1
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform all cinemas not part of a large chain (Part 2)
  # ------------------------------------------------------------------------------
  transform_remaining_2:
    name: Transform Remaining 2
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: lumiereromford.com
        run: npx clusterflick/scripts transform lumiereromford.com
      - name: metrocinema.co.uk
        run: npx clusterflick/scripts transform metrocinema.co.uk
      - name: backyardcinema.co.uk
        run: npx clusterflick/scripts transform backyardcinema.co.uk
      - name: eventimapollo.com
        run: npx clusterflick/scripts transform eventimapollo.com
      - name: lost.org
        run: npx clusterflick/scripts transform lost.org
      - name: thenickel.co.uk
        run: npx clusterflick/scripts transform thenickel.co.uk
      - name: thegardencinema.co.uk
        run: npx clusterflick/scripts transform thegardencinema.co.uk
      - name: richmix.org.uk
        run: npx clusterflick/scripts transform richmix.org.uk
      - name: closeupfilmcentre.com
        run: npx clusterflick/scripts transform closeupfilmcentre.com
      - name: forestcinema.co.uk
        run: npx clusterflick/scripts transform forestcinema.co.uk

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_remaining_2
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform all cinemas not part of a large chain (Part 3)
  # ------------------------------------------------------------------------------
  transform_remaining_3:
    name: Transform Remaining 3
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: arthousecrouchend.co.uk
        run: npx clusterflick/scripts transform arthousecrouchend.co.uk
      - name: thecastlecinema.com
        run: npx clusterflick/scripts transform thecastlecinema.com
      - name: castlesidcup.com
        run: npx clusterflick/scripts transform castlesidcup.com
      - name: davidleancinema.org.uk
        run: npx clusterflick/scripts transform davidleancinema.org.uk
      - name: kilntheatre.com
        run: npx clusterflick/scripts transform kilntheatre.com
      - name: sandsfilms.co.uk
        run: npx clusterflick/scripts transform sandsfilms.co.uk
      - name: coldharbourblue.com
        run: npx clusterflick/scripts transform coldharbourblue.com
      - name: goodshepherdstudios.com
        run: npx clusterflick/scripts transform goodshepherdstudios.com
      - name: thebathhouse.co
        run: npx clusterflick/scripts transform thebathhouse.co

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_remaining_3
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Transform all cinemas not part of a large chain (Part 4)
  # ------------------------------------------------------------------------------
  transform_remaining_4:
    name: Transform Remaining 4
    needs: [download_retrieved_data, download_historical_data]
    runs-on: ubuntu-latest
    env:
      TZ: Europe/London
      MOVIEDB_API_KEY: ${{ secrets.MOVIEDB_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      PAT: ${{ secrets.PAT }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install
      - name: Set cache date
        run: echo "CACHE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Cache LLM responses
        uses: actions/cache@v3
        with:
          path: cache-llm
          key: cache-llm-${{ github.job }}-${{ env.CACHE_DATE }}
      - name: Download Retrieved Data
        uses: actions/download-artifact@v4
        with:
          name: retrieved-data
          path: retrieved-data/
      - name: Download Historical Data
        uses: actions/download-artifact@v4
        with:
          name: combined-data
          path: combined-data/

      - name: siobhandavies.com
        run: npx clusterflick/scripts transform siobhandavies.com
      - name: thelondonarchives.org
        run: npx clusterflick/scripts transform thelondonarchives.org
      - name: peckhamplex.london
        run: npx clusterflick/scripts transform peckhamplex.london
      - name: royalalberthall.com
        run: npx clusterflick/scripts transform royalalberthall.com
      - name: omniplex.co.uk-sutton
        run: npx clusterflick/scripts transform omniplex.co.uk-sutton
      - name: fulhampier.com
        run: npx clusterflick/scripts transform fulhampier.com
      - name: acflondon.org
        run: npx clusterflick/scripts transform acflondon.org
      - name: thehorsehospital.com
        run: npx clusterflick/scripts transform thehorsehospital.com
      - name: thehammondtheatre.co.uk
        run: npx clusterflick/scripts transform thehammondtheatre.co.uk
      - name: lewisham.gov.uk-deptford-lounge
        run: npx clusterflick/scripts transform lewisham.gov.uk-deptford-lounge
      - name: bbk.ac.uk-central
        run: npx clusterflick/scripts transform bbk.ac.uk-central
      - name: bbk.ac.uk-cinema
        run: npx clusterflick/scripts transform bbk.ac.uk-cinema
      - name: dugdaleartscentre.co.uk
        run: npx clusterflick/scripts transform dugdaleartscentre.co.uk
      - name: sydenhamarts.co.uk
        run: npx clusterflick/scripts transform sydenhamarts.co.uk
      - name: whitechapelgallery.org
        run: npx clusterflick/scripts transform whitechapelgallery.org

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transform_remaining_4
          path: transformed-data/

  # ------------------------------------------------------------------------------
  # Create release using data from all jobs
  # ------------------------------------------------------------------------------
  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      [
        transform_bfi,
        transform_cineworld,
        transform_curzon,
        transform_electric_cinema,
        transform_tate,
        transform_firmdale_hotels,
        transform_everyman,
        transform_vue,
        transform_odeon,
        transform_picturehouses,
        transform_organisations_1,
        transform_organisations_2,
        transform_external_events_1,
        transform_external_events_2,
        transform_external_events_3,
        transform_external_events_4,
        transform_external_events_5,
        transform_external_events_6,
        transform_remaining_1,
        transform_remaining_2,
        transform_remaining_3,
        transform_remaining_4,
      ]
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: transformed-data/
          pattern: transform_*
          merge-multiple: true
      - name: Generate Tag
        run: echo "TAG=$(TZ=Europe/London date +'%Y%m%d.%H%M%S')" >> $GITHUB_ENV
      - uses: ncipollo/release-action@v1
        id: release
        with:
          allowUpdates: false
          artifactErrorsFailBuild: true
          artifacts: "transformed-data/*"
          makeLatest: true
          tag: ${{ env.TAG }}
          commit: main
          body: |
            Created by job ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      - name: Output summary
        run: |
          echo " New release - ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Repository Dispatch for data-cached
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: clusterflick/data-cached
          event-type: release_event

      - name: Repository Dispatch for data-calendar
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: clusterflick/data-calendar
          event-type: release_event

      - name: Repository Dispatch for data-analysed
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: clusterflick/data-analysed
          event-type: compare_releases

      - name: Repository Dispatch for scripts
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          repository: clusterflick/scripts
          event-type: release_event
